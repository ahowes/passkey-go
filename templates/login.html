<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Passkey Go</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .container { background: #fff; padding: 3rem; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); text-align: center; max-width: 480px; width: 90%; }
        h1 { margin-bottom: 0.5rem; font-size: 1.5rem; }
        p.subtitle { margin-bottom: 2rem; color: #666; font-size: 0.9rem; }
        button { width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; background: #4f46e5; color: #fff; transition: background 0.2s; }
        button:hover { background: #4338ca; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .status { margin-top: 1rem; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem; display: none; }
        .status.error { display: block; background: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .status.success { display: block; background: #f0fdf4; color: #16a34a; border: 1px solid #bbf7d0; }
        .status.info { display: block; background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; }
        .back { display: block; text-align: center; margin-top: 1.5rem; color: #4f46e5; text-decoration: none; font-size: 0.9rem; }
        .register-link { margin-top: 1rem; font-size: 0.9rem; color: #666; }
        .register-link a { color: #4f46e5; text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sign In</h1>
        <p class="subtitle">Use your passkey to sign in</p>
        <button type="button" id="loginBtn" onclick="login()">Sign in with Passkey</button>
        <div id="status" class="status"></div>
        <p class="register-link">Don't have an account? <a href="/register">Register</a></p>
        <a href="/" class="back">Back to home</a>
    </div>
    <script>
        function bufferToBase64url(buffer) {
            const bytes = new Uint8Array(buffer);
            let str = '';
            for (const b of bytes) str += String.fromCharCode(b);
            return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
        }

        function base64urlToBuffer(base64url) {
            const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
            const padded = base64 + '='.repeat((4 - base64.length % 4) % 4);
            const binary = atob(padded);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
            return bytes.buffer;
        }

        function setStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = 'status ' + type;
        }

        async function login() {
            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Starting sign in...';
            setStatus('Contacting server...', 'info');

            try {
                const beginResp = await fetch('/api/login/begin', {
                    method: 'POST',
                });

                if (!beginResp.ok) {
                    const err = await beginResp.json();
                    throw new Error(err.error || 'Login failed');
                }

                const options = await beginResp.json();

                options.publicKey.challenge = base64urlToBuffer(options.publicKey.challenge);
                if (options.publicKey.allowCredentials) {
                    options.publicKey.allowCredentials = options.publicKey.allowCredentials.map(c => ({
                        ...c,
                        id: base64urlToBuffer(c.id),
                    }));
                }

                setStatus('Please select a passkey...', 'info');
                const assertion = await navigator.credentials.get(options);

                setStatus('Verifying with server...', 'info');

                const assertionResponse = {
                    id: assertion.id,
                    rawId: bufferToBase64url(assertion.rawId),
                    type: assertion.type,
                    response: {
                        authenticatorData: bufferToBase64url(assertion.response.authenticatorData),
                        clientDataJSON: bufferToBase64url(assertion.response.clientDataJSON),
                        signature: bufferToBase64url(assertion.response.signature),
                        userHandle: bufferToBase64url(assertion.response.userHandle),
                    },
                };

                if (assertion.authenticatorAttachment) {
                    assertionResponse.authenticatorAttachment = assertion.authenticatorAttachment;
                }

                const finishResp = await fetch('/api/login/finish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(assertionResponse),
                });

                if (!finishResp.ok) {
                    const err = await finishResp.json();
                    throw new Error(err.error || 'Login verification failed');
                }

                setStatus('Login successful! Redirecting...', 'success');
                setTimeout(() => { window.location.href = '/dashboard'; }, 1000);

            } catch (err) {
                console.error('Login error:', err);
                setStatus(err.message || 'Login failed. Please try again.', 'error');
                btn.disabled = false;
                btn.textContent = 'Sign in with Passkey';
            }
        }
    </script>
</body>
</html>
